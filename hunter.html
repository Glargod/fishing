<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bob's Deer Slaying Website</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.5.0/ol.css" />
  <style>
    body { font-family: Arial, sans-serif; background-color: #f0f0f0; margin: 0; }
    #map { height: 500px; width: 100%; border: 2px solid #4a2f1a; }
    #header { text-align: center; background-color: #4a2f1a; color: white; padding: 10px; }
    #funIsOver, #forceFallback {
      display: block; margin: 10px auto; padding: 15px; font-size: 18px;
      background-color: #8b5a2b; color: white; border: none; cursor: pointer;
      border-radius: 5px; }
    #funIsOver:hover, #forceFallback:hover { background-color: #a66c39; }
    #status, #mgrs { text-align: center; color: #4a2f1a; font-weight: bold; margin: 5px; }
  </style>
</head>
<body>
  <div id="header">
    <h1>Bob's Deer Slaying Website</h1>
    <p>Track your hunt at 1:50,000 scale and hear the big moment!</p>
  </div>
  <div id="map"></div>
  <p id="mgrs">MGRS: Waiting for location...</p>
  <button id="funIsOver">Fun is Over</button>
  <button id="forceFallback">Use Fallback Location</button>
  <p id="status">Initializing map...</p>

  <script src="https://cdn.jsdelivr.net/npm/ol@v7.5.0/dist/ol.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/proj4@2.8.0/dist/proj4.min.js"></script>
  <script src="https://unpkg.com/mgrs@1.0.0/dist/mgrs.min.js"></script>
  <script>
    // Log script start
    console.log('Script started at', new Date().toLocaleString());

    // Initialize map with Web Mercator (EPSG:3857)
    let map;
    try {
      map = new ol.Map({
        target: 'map',
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM({
              url: 'https://{a-c}.tile.openstreetmap.org/{z}/{x}/{y}.png',
              projection: 'EPSG:3857',
              tileLoadFunction: (tile, src) => {
                const img = tile.getImage();
                img.src = src;
                img.onerror = () => {
                  console.error('Tile load error:', src);
                  document.getElementById('status').textContent = 'Map tiles failed. Check internet.';
                };
                img.onload = () => {
                  console.log('Tiles loaded successfully');
                  document.getElementById('status').textContent = 'Map loaded; waiting for location...';
                };
              }
            })
          })
        ],
        view: new ol.View({
          projection: 'EPSG:3857',
          center: ol.proj.fromLonLat([-64.35, 45.65], 'EPSG:3857'), // Springhill Junction, NS
          zoom: 14 // Approx 1:50,000 scale
        })
      });
      console.log('Map initialized successfully');
    } catch (e) {
      console.error('Map initialization error:', e);
      document.getElementById('status').textContent = 'Map failed to initialize. Check console.';
    }

    // Add MGRS grid (1km)
    try {
      const gridLayer = new ol.layer.Graticule({
        strokeStyle: new ol.style.Stroke({ color: '#4a2f1a', width: 1 }),
        showLabels: true,
        intervals: [1000],
        latLabelFormatter: (lat) => {
          try {
            const lonLat = ol.proj.toLonLat([0, lat], 'EPSG:3857');
            return window.mgrs.forward(lonLat, 2).slice(0, 5);
          } catch (e) {
            console.error('MGRS lat label error:', e);
            return '';
          }
        },
        lonLabelFormatter: (lon) => {
          try {
            const lonLat = ol.proj.toLonLat([lon, 0], 'EPSG:3857');
            return window.mgrs.forward(lonLat, 2).slice(5, 7);
          } catch (e) {
            console.error('MGRS lon label error:', e);
            return '';
          }
        }
      });
      map.addLayer(gridLayer);
      console.log('MGRS grid added');
    } catch (e) {
      console.error('Grid layer error:', e);
    }

    // Location tracking
    let marker = new ol.Feature();
    const vectorLayer = new ol.layer.Vector({
      source: new ol.source.Vector({ features: [marker] }),
      style: new ol.style.Style({
        image: new ol.style.Circle({
          radius: 6,
          fill: new ol.style.Fill({ color: '#ff0000' }),
          stroke: new ol.style.Stroke({ color: '#fff', width: 2 })
        })
      })
    });
    map.addLayer(vectorLayer);

    // Fallback location (Springhill Junction, NS)
    const fallbackCoords = [-64.35, 45.65];
    let locationSet = false;

    // Update map with coordinates
    function updateMap(coords, isFallback = false) {
      try {
        console.log('Updating map with coords:', coords, 'isFallback:', isFallback);
        const mercatorCoords = ol.proj.fromLonLat(coords, 'EPSG:3857');
        marker.setGeometry(new ol.geom.Point(mercatorCoords));
        map.getView().setCenter(mercatorCoords);
        const mgrs = window.mgrs.forward(coords, 6);
        document.getElementById('mgrs').textContent = `MGRS${isFallback ? ' (Fallback)' : ''}: ${mgrs}`;
        document.getElementById('status').textContent = `Map and location active${isFallback ? ' (using fallback)' : ''}`;
        console.log('Location updated:', coords, 'MGRS:', mgrs, isFallback ? '(Fallback)' : '');
        locationSet = true;
      } catch (e) {
        console.error('Error updating map:', e);
        document.getElementById('status').textContent = 'Error updating map. Check console.';
      }
    }

    // Check geolocation support
    if (!navigator.geolocation) {
      console.error('Geolocation not supported by browser');
      document.getElementById('status').textContent = 'Geolocation not supported. Using fallback.';
      updateMap(fallbackCoords, true);
    } else {
      const geolocation = new ol.Geolocation({
        tracking: true,
        trackingOptions: {
          enableHighAccuracy: true,
          timeout: 7000,
          maximumAge: 0
        },
        projection: 'EPSG:4326'
      });

      geolocation.on('change:position', () => {
        const coords = geolocation.getPosition();
        console.log('Geolocation position:', coords);
        if (coords && coords[0] !== undefined && coords[1] !== undefined) {
          updateMap(coords);
        } else {
          console.warn('Geolocation returned invalid or null position');
          document.getElementById('status').textContent = 'Invalid location data. Using fallback.';
          updateMap(fallbackCoords, true);
        }
      });

      geolocation.on('error', (error) => {
        console.error('Geolocation error:', error.message);
        document.getElementById('status').textContent = `Location error: ${error.message}. Using fallback.`;
        updateMap(fallbackCoords, true);
      });

      // Force fallback after timeout
      setTimeout(() => {
        if (!locationSet) {
          console.warn('Geolocation timeout, using fallback');
          document.getElementById('status').textContent = 'Geolocation timed out. Using fallback location.';
          updateMap(fallbackCoords, true);
        }
      }, 10000);
    }

    // Manual fallback button
    try {
      document.getElementById('forceFallback').addEventListener('click', () => {
        console.log('Manual fallback button clicked');
        geolocation.setTracking(false); // Stop geolocation attempts
        document.getElementById('status').textContent = 'Using fallback location (manual).';
        updateMap(fallbackCoords, true);
      });
      console.log('Fallback button listener added');
    } catch (e) {
      console.error('Fallback button error:', e);
    }

    // Text-to-Speech setup
    const synth = window.speechSynthesis;
    function speak(message) {
      try {
        const utterance = new SpeechSynthesisUtterance(message);
        utterance.voice = synth.getVoices().find(voice => voice.lang.includes('en')) || synth.getVoices()[0];
        utterance.rate = 1;
        utterance.pitch = 1;
        synth.speak(utterance);
        console.log('Speaking:', message);
      } catch (e) {
        console.error('Speech error:', e);
      }
    }

    // Fun is Over button
    try {
      document.getElementById('funIsOver').addEventListener('click', () => {
        console.log('Fun is Over button clicked');
        navigator.geolocation.getCurrentPosition((position) => {
          const lonLat = [position.coords.longitude, position.coords.latitude];
          const mgrs = window.mgrs.forward(lonLat, 6);
          const message = `Bob just shot a deer, advise me to go to grid ${mgrs}.`;
          document.getElementById('status').textContent = `Playing voice: "${message}"`;
          console.log('Playing TTS:', message);
          speak(message);
        }, (error) => {
          console.error('Button geolocation error:', error.message);
          const mgrs = window.mgrs.forward(fallbackCoords, 6);
          const message = `Bob just shot a deer, advise me to go to grid ${mgrs}.`;
          document.getElementById('status').textContent = `Playing voice (fallback): "${message}"`;
          console.log('Playing TTS (fallback):', message);
          speak(message);
        }, {
          enableHighAccuracy: true,
          timeout: 5000,
          maximumAge: 0
        });
      });
      console.log('Fun is Over button listener added');
    } catch (e) {
      console.error('Fun is Over button error:', e);
    }
  </script>
</body>
</html>
